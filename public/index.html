<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="css/jquery-ui-1.10.3/jquery-ui.min.css"/>
    <script src="js/jquery-1.9.1.min.js"></script>
    <script src="js/jquery-ui-1.10.3/jquery-ui.min.js"></script>
    <script src="js/DPAGraphs.js"></script>
    <style>

div.drag {
    clear: none;
    float: left;
    position: relative;
    margin: 5px;
    border-style: ridge;
    border-width: 3px;
    border-color: grey;
    cursor: pointer;
}

div.close {
    position: absolute;
    top: 0;
    left: 98%;
}

.gnuplot {
    width: 720px;
    height: 504px;
}

th {
    text-align: right;
}
    </style>
</head>
<body>
<h1>DataCore Performance Analyzer</h1>

<div id="div_meta">
<table>
    <tr>
	<th>Run Name:</th>
	<td><select id="sel_run"></select> <button id="btn_upload">Upload</button> <button id="btn_drop">Drop</button> </td>
    </tr>
    <tr>
	<th></th>
	<td><pre id="meta"></pre></td>
    </tr>
    <tr>
	<th colspan="2"><hr/></th>
    </tr>
    <tr>
	<th>Presentation:</th>
	<td id="rad_graph">
	    <input type="radio" name="rad_graph" id="trend" checked="1" /><label for="inp_trend">trend</label>
	    <input type="radio" name="rad_graph" id="histogram" /><label for="inp_histogram">histogram</label>
	    <input type="radio" name="rad_graph" id="correlation" /><label for="inp_correlation">correlation</label>
	</td>
    </tr>
    <tr>
	<th>Time Frame:</th>
	<td><div id="sli_range"></div></td>
    </tr>
    <tr>
	<th></th>
	<td id="txt_range"></td>
    </tr>
    <tr>
	<th>Axes:</th>
	<td>
	    <table>
		<tr>
		    <th>X&nbsp;&rarr;</th>
		    <td>
	    <ul id="ul-menu-x">
		<li>
		    <a id="a-sel-x" href="#">Time</a>
		    <ul id="ul-submenu-x"></ul>
		</li>
	    </ul>
		    </td>
		</tr>
	    </table>
	</td>
    </tr>
    <tr>
	<th></th>
	<td>
	    <table>
		<tr>
		    <th>Y&nbsp;&rarr;</th>
		    <td>
	    <ul id="ul-menu-y">
		<li>
		    <a id="a-sel-y" href="#">-</a>
		    <ul id="ul-submenu-y"></ul>
		</li>
	    </ul>
		    </td>
		</tr>
	    </table>
	</td>
    </tr>
    <tr>
	<th></th>
	<td>
	    <table>
		<tr>
		    <th>Z&nbsp;&rarr;</th>
		    <td>
	    <ul id="ul-menu-z">
		<li>
		    <a id="a-sel-z" href="#">-</a>
		    <ul id="ul-submenu-z"></ul>
		</li>
	    </ul>
		    </td>
		</tr>
	    </table>
	</td>
    </tr>
    <tr>
	<th></th>
	<td><button id="btn_apply">Apply</button> <button id="btn_add">Add</button></td>
    </tr>
</table>


</div>

<div id="div_content">
</div>

<script>
var $graph;
var $rname;
var $runs = { };
var $meta = { };
var $counters = { };
var $rows =  { x: [[1]] };

function sorted_keys(data) {
    var keys = [ ];
    for(k in data) {
	keys.push(k)
    }

    keys.sort(function(a,b) {
	if(a < b) return -1;
	if(a > b) return 1;

	if(data[a] < data[b]) return -1;
	if(data[a] > data[b]) return 1;
	
	return 0;
    });

    return keys;
}

function getParams(x, y) {
    var v = $('#sli_range').slider('values');

    return {
	run: $rname,
	ptype: $('#rad_graph :radio:checked').attr('id'),
	from: v[0],
	to: v[1],
	x: x,
	y: y,
    };
}

function menu_getsel(content, prefix, level, path) {
    var ret = [];
    var l = level + 1;

    $.each(sorted_keys(content), function(i, key) {
	var p = prefix + ':' + key;
	if(l < 4) { //>
	    var r = (l == 3 ?
		    menu_getsel(content[key]['Counters'], p, l, path)
		:
		    menu_getsel(content[key], p, l, path)
	    );

	    if(r != undefined && r.length > 0)
		(l == 3 ? ret.push(r) : ret = ret.concat(r));
	}
	else {
	    if(p.indexOf(path) == 0)
		ret.push(content[key]['index']);
	}
    });

    if(ret.length > 0)
	return(ret);
}

function menu_builder(content, prefix, level) {
    var ret = [ ];
    var l = level + 1;

    $.each(sorted_keys(content), function(i, key) {
	var p = prefix + ':' + key;
	if(l < 4) { //>
	    var r = (l == 3 ?
		menu_builder(content[key]['Counters'], p, l)
		:
		menu_builder(content[key], p, l)
	    );

	    if(r.length > 0) {
		ret.push('<li id="#' + p + '"><a href="#">' + key + '</a><ul>');
		ret.push(r);
		ret.push('</ul></li>');
	    }
	}
	else {
	    ret.push('<li id="#' + p + '"><a href="#">' + key + '</a></li>');
	}
    });

    return ret.join("\n");
}

function init_run() {
    $( "#sli_range" ).slider({
	min: $meta[$rname]['ffrom_ut'],
	max: $meta[$rname]['fto_ut'],
	values: [$meta[$rname]['ffrom_ut'], $meta[$rname]['fto_ut']],
	range: true,
	step: 120,
	change: function(event, ui) {
	    var df = new Date(ui.values[0]*1000);
	    var dt = new Date(ui.values[1]*1000);
	    $('#txt_range').text( df.toLocaleString() + ' - ' + dt.toLocaleString() );
	},
    }).slider( 'value', $( '#sli_range' ).slider('value') );

    $('#meta').text($meta[$rname]['cmdline']);

    var men_selected = function (event, ui) {
	    var id = ui.item[0].id.substring(1);
	    $('#a-sel-' + this.id.slice(-1)).text( id.substring(7).split(':').join(' / ') );

	    $rows[this.id.slice(-1)] = menu_getsel($counters[$rname], id.substring(0,6), 0, id);
    };


    var axis = ['x', 'y', 'z'];
    for (i in axis) {
	var a = axis[i];

	$('#ul-submenu-' + a).html($( menu_builder($counters[$rname], "menu-" + a, 0) ));
	$('#ul-menu-' + a).menu({
	    disabled: (a == 'y' ? false : true),
	    select: men_selected,
	});
    }
}

$('#sel_run').change(function() {
    $('#sel_run option:selected').each(function() {
	$rname = $(this).text();
	if($rname in $counters) {
	    init_run();
	} else {
	    var p = ['raw', $rname, 'counters.json'];
	    $.getJSON(p.join('/'), function(data) {
		$counters[$rname] = data;
		init_run();
	    });
	}
    });
});

$.getJSON('raw/manifest.json', function(data) {
    $.each(sorted_keys(data), function(i, key) {
	val = data[key];
	$('#sel_run').append($('<option>', {
	    value: key,
	    text: key,
	}));

	$runs[key] = val;

	var p = ['raw', key, 'meta.json'];
	$.getJSON(p.join('/'), function(data) {
	    $meta[key] = data;
	});
    });

    $('#sel_run').change();
});

$(function() {
    $('#rad_graph').buttonset();

    $('#btn_apply').button({
	disabled: true,
	icons: { primary: 'ui-icon-pencil' },
    }).click(function() {
	$.each($rows['x'], function(i, x) {
	    $.each(x, function(ii, x2) {
		$.each($rows['y'], function(j, y) {
		    DPAGraphs.updateGraph($graph, getParams(x2, y));
		});
	    });
	});
    });

    $('#btn_add').button({
	icons: { primary: 'ui-icon-plus' },
    }).click(function() {
	$.each($rows['x'], function(i, x) {
	    $.each(x, function(ii, x2) {
		$.each($rows['y'], function(j, y) {
		    $graph = DPAGraphs.addGraph('#div_content', getParams(x2, y));
		});
	    });
	});
    });

    $('#btn_upload').button({
	disabled: true,
	icons: { primary: 'ui-icon-plus' },
    }).click(function() {
	// TODO
    });

    $('#btn_drop').button({
	disabled: true,
	icons: { primary: 'ui-icon-minus' },
    }).click(function() {
	// TODO
    });
});
</script>
</body>

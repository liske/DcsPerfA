<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css"/>
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
    <style>

div.drag {
    clear: none;
    float: left;
    position: relative;
    margin: 5px;
    border-style: ridge;
    border-width: 3px;
    border-color: grey;
}

div.close {
    position: absolute;
    top: 0;
    left: 98%;
}

th {
    text-align: right;
}
    </style>
</head>
<body>
<h1>DataCore Performance Analyzer</h1>

<div id="div_meta">
<table>
    <tr>
	<th>Run Name:</th>
	<td><select id="sel_run"></select></td>
    </tr>
    <tr>
	<th>Presentation:</th>
	<td id="rad_graph">
	    <input type="radio" name="graph" id="inp_trend" selected="1" /><label for="inp_trend">trend</label>
	    <input type="radio" name="graph" id="inp_histogram" /><label for="inp_histogram">histogram</label>
	    <input type="radio" name="graph" id="inp_correlation" /><label for="inp_correlation">correlation</label>
	</td>
    </tr>
    <tr>
	<th>Time Frame:</th>
	<td><div id="sli_range"></div></td>
    </tr>
    <tr>
	<th>X Axis:</th>
	<td>
	    <ul id="ul-menu-x">
		<li>
		    <a id="a-sel-x" href="#">Time</a>
		    <ul id="ul-submenu-x"></ul>
		</li>
	    </ul>
	</td>
	<th>Y Axis:</th>
	<td>
	    <ul id="ul-menu-y">
		<li>
		    <a id="a-sel-y" href="#">-</a>
		    <ul id="ul-submenu-y"></ul>
		</li>
	    </ul>
	</td>
	<th>Z Axis:</th>
	<td>
	    <ul id="ul-menu-z">
		<li>
		    <a id="a-sel-z" href="#">-</a>
		    <ul id="ul-submenu-z"></ul>
		</li>
	    </ul>
	</td>
    </tr>
</table>

<pre id="meta"></pre>
</div>

<div id="div_content">
</div>

<script>
    var $rname;
    var $runs = { };
    var $meta = { };
    var $counters = { };

function sorted_keys(data) {
    var keys = [ ];
    for(k in data) {
	keys.push(k)
    }

    keys.sort(function(a,b) {
	if(a < b) return -1;
	if(a > b) return 1;

	if(data[a] < data[b]) return -1;
	if(data[a] > data[b]) return 1;
	
	return 0;
    });

    return keys;
}


function init_run() {
    $( "#rad_graph" ).buttonset();
    $( "#sli_range" ).slider({
	min: $meta[$rname]['ffrom_ut'],
	max: $meta[$rname]['fto_ut'],
	values: [$meta[$rname]['ffrom_ut'], $meta[$rname]['fto_ut']],
	range: true,
	step: 7200,
    });

    $('#meta').html(
	"<b>Time Range  :</b> " + $meta[$rname]['ffrom_lt'] + " - " + $meta[$rname]['fto_lt'] + "\n" + 
	"<b>Command Line:</b> " + $meta[$rname]['cmdline']);

    var men_selected = function (event, ui) {
	    $('#a-sel-' + this.id.slice(-1)).text( ui.item[0].textContent );
	    var id = ui.item[0].id.substring(1);
	    var add = [ ];

	    if(id in refs) {
		add.push(id);
	    }
	    else if(id.substring(0, 3) == 'gr_') {
		id = 'co' + id.substring(2) + '_';
		len = id.length;
		$.each(refs, function(k, v) {
		    if(k.substring(0, len) == id) {
			add.push(k);
		    }
		});
	    }
	    $.each(add, function(i, id) {
		$.each(['trend', 'histogram'], function(j, n) {
		    var close = $('<div/>', {
			title: 'close',
			class: 'close',
			html: '<b>x</b>',
		    });
		    close.click(function() {
			$('#' + id).remove();
		    });

		    $('<div/>', {
			id: id,
			title: titles[id],
			class: 'drag',
		    }).appendTo('#div_content').draggable().append('<img src="' + refs[id]['Images'][n] + '"/>').append(close);
		});
	    });
    };

    refs = { };
    titles = { };
    hc = [ ];
    $.each(sorted_keys($counters[$rname]), function(i, ty) {
	pi = $counters[$rname][ty];
	hc.push('<li id="#ty_' + ty + '"><a href="#">' + ty + '</a><ul>');
	$.each(sorted_keys(pi), function(j, gr) {
	    hc.push('<li id="#gr_' + i + '_' + j + '"><a href="#">' + gr + '</a><ul>');
	    $.each(sorted_keys(pi[gr]), function(k, co) {
		refs['co_' + i + '_' + j + '_' + k] = pi[gr][co];
		titles['co_' + i + '_' + j + '_' + k] = gr + ': ' + co;
		hc.push('<li id="#co_' + i + '_' + j + '_' + k + '"><a href="#">' + co + '</a></li>');
	    });
	    hc.push('</ul></li>');
	});
	hc.push('</ul></li>');
    });

    var axis = ['x', 'y', 'z'];
    for (i in axis) {
	var a = axis[i];

	$('#ul-submenu-' + a).html($(hc.join("\n")));
	$('#ul-menu-' + a).menu({
	    select: men_selected,
	});
    }
}

$('#sel_run').change(function() {
    $('#sel_run option:selected').each(function() {
	$rname = $(this).text();
	if($rname in $counters) {
	    init_run();
	} else {
	    var p = ['raw', $rname, 'counters.json'];
	    $.getJSON(p.join('/'), function(data) {
		$counters[$rname] = data;
		init_run();
	    });
	}
    });
});

$.getJSON('raw/manifest.json', function(data) {
    $.each(sorted_keys(data), function(i, key) {
	val = data[key];
	$('#sel_run').append($('<option>', {
	    value: key,
	    text: key,
	}));

	$runs[key] = val;

	var p = ['raw', key, 'meta.json'];
	$.getJSON(p.join('/'), function(data) {
	    $meta[key] = data;
	});
    });

    $('#sel_run').change();
});
</script>
</body>

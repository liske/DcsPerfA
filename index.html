<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <link rel="stylesheet" type="text/css" href="http://code.jquery.com/ui/1.10.2/themes/smoothness/jquery-ui.css"/>
    <script src="http://code.jquery.com/jquery-1.9.1.js"></script>
    <script src="http://code.jquery.com/ui/1.10.2/jquery-ui.js"></script>
    <style>
.ui-menu .ui-menu-item {
margin:10px;
padding: 0;
zoom: 1;
float: left;

clear: none;
width: auto;
}
#menu li { width: auto; clear: none; }

.ui-menu .ui-menu-item a{
padding: 2px .2em;
}
    </style>
</head>
<body>
<h1>DataCore Performance Analyzer</h1>

<div id="div_meta" style="background: lightgreen">
<pre><b>Run Name    :</b> <select id="sel_run"></select></pre>
<pre id="meta"></pre>
</div>

<div id="div_menu">
</div>

<div id="div_content">
</div>

<script>
    var $rname;
    var $runs = { };
    var $meta = { };
    var $counters = { };

function sorted_keys(data) {
    var keys = [ ];
    for(k in data) {
	keys.push(k)
    }

    keys.sort(function(a,b) {
	if(a < b) return -1;
	if(a > b) return 1;

	if(data[a] < data[b]) return -1;
	if(data[a] > data[b]) return 1;
	
	return 0;
    });

    return keys;
}

function init_run() {
    $('#meta').html(
	"<b>Time Range  :</b> " + $meta[$rname]['ffrom_lt'] + " - " + $meta[$rname]['fto_lt'] + "\n" + 
	"<b>Command Line:</b> " + $meta[$rname]['cmdline']);

    refs = { };
    titles = { };
    hc = [ '<ul id="menu">' ];
    $.each(sorted_keys($counters[$rname]), function(i, ty) {
	pi = $counters[$rname][ty];
	hc.push('<li id="#ty_' + ty + '"><a href="#">' + ty + '</a><ul>');
	$.each(sorted_keys(pi), function(j, gr) {
	    hc.push('<li id="#gr_' + i + '_' + j + '"><a href="#">' + gr + '</a><ul>');
	    $.each(sorted_keys(pi[gr]), function(k, co) {
		refs['co_' + i + '_' + j + '_' + k] = pi[gr][co];
		titles['co_' + i + '_' + j + '_' + k] = gr + ': ' + co;
		hc.push('<li id="#co_' + i + '_' + j + '_' + k + '"><a href="#">' + co + '</a></li>');
	    });
	    hc.push('</ul></li>');
	});
	hc.push('</ul></li>');
    });
    hc.push('</ul>');
    $('#div_menu').html($(hc.join("\n")));
    $('#menu').menu({
        select: function (event, ui) {
	    var id = ui.item[0].id.substring(1);
	    var add = [ ];

	    if(id in refs) {
		add.push(id);
	    }
	    else if(id.substring(0, 3) == 'gr_') {
		id = 'co' + id.substring(2) + '_';
		len = id.length;
		$.each(refs, function(k, v) {
		    if(k.substring(0, len) == id) {
			add.push(k);
		    }
		});
	    }
	    $.each(add, function(i, id) {
		$('<div/>', {
		    id: id,
		    title: titles[id],
		}).appendTo('#div_content').append('<img src="' + refs[id]['Images']['trend'] + '"/>');;
	    });
        }
    });
}

$('#sel_run').change(function() {
    $('#sel_run option:selected').each(function() {
	$rname = $(this).text();
	if($rname in $counters) {
	    init_run();
	} else {
	    var p = ['raw', $rname, 'counters.json'];
	    $.getJSON(p.join('/'), function(data) {
		$counters[$rname] = data;
		init_run();
	    });
	}
    });
});

$.getJSON('raw/manifest.json', function(data) {
    $.each(data, function(key, val) {
	$('#sel_run').append($('<option>', {
	    value: key,
	    text: key,
	}));

	$runs[key] = val;

	var p = ['raw', key, 'meta.json'];
	$.getJSON(p.join('/'), function(data) {
	    $meta[key] = data;
	});
    });

    $('#sel_run').change();
});
</script>
</body>
